<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>윤서가 영어를 너무 싫어해서 엄마가 만든 영어 단어장</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="word-card">
    <img id="word-image" src="" alt="word-image">
    <h2 id="english-word">단어</h2>
    <p id="korean-meaning">드시</p>
    <p id="example-sentence">예문</p>

    <div>
        <button onclick="nextWord()">다음 단어</button>
        <button onclick="toggleFlash()" id="flash-btn">플래시 시작</button>
    </div>
</div>

<div class="external-buttons" id="external-buttons">
    <button id="story-btn">동화 보러 가기</button>
    <button id="storybook-btn">동화책 보러 가기</button>
</div>

<script src="words.js"></script>
<script src="books.js"></script>
<script>
const urlParams = new URLSearchParams(window.location.search);
let requestedId = urlParams.get('id');

// bookId 선택 로직
let bookId;
const bookKeys = Object.keys(books);

if (!requestedId) {
    bookId = bookKeys[bookKeys.length - 1]; // 마지막 요소
} else if (books[requestedId]) {
    bookId = requestedId; // 정확히 일치
} else {
    // 접두어로 시작하는 항목 중 마지막 항목
    const matched = bookKeys.filter(key => key.startsWith(requestedId));
    bookId = matched.length > 0 ? matched[matched.length - 1] : bookKeys[bookKeys.length - 1];
}

let currentWords = words.filter(word => word.id === bookId);

let currentIndex = 0;
let flashInterval;
let flashRunning = false;

function showWord(index) {
    const word = currentWords[index];
    document.getElementById('word-image').src = word.image;
    document.getElementById('english-word').innerText = word.english;
    document.getElementById('korean-meaning').innerText = word.korean;
    document.getElementById('example-sentence').innerText = word.example;
}

function nextWord() {
    currentIndex = (currentIndex + 1) % currentWords.length;
    showWord(currentIndex);

    const word = currentWords[currentIndex];
    if (word.audio) {
        const audio = new Audio(word.audio);
        audio.play().catch(err => {
            console.warn("Audio playback failed:", err);
        });
    }
}

function toggleFlash() {
    const flashBtn = document.getElementById('flash-btn');
    if (!flashRunning) {
        nextWord();
        flashInterval = setInterval(() => {
            nextWord();
        }, 3000);
        flashBtn.innerText = '플래시 중지';
    } else {
        clearInterval(flashInterval);
        flashBtn.innerText = '플래시 시작';
    }
    flashRunning = !flashRunning;
}

function setButtonLinks() {
    const storyBtn = document.getElementById('story-btn');
    const storybookBtn = document.getElementById('storybook-btn');
    const externalButtons = document.getElementById('external-buttons');

    if (books[bookId]) {
        const storyUrl = books[bookId].storyUrl;
        const storybookUrl = books[bookId].storybookUrl;

        let hasContent = false;

        if (storyUrl) {
            storyBtn.onclick = () => window.open(storyUrl, '_blank');
            hasContent = true;
        } else {
            storyBtn.style.display = 'none';
        }

        if (storybookUrl) {
            storybookBtn.onclick = () => window.open(storybookUrl, '_blank');
            hasContent = true;
        } else {
            storybookBtn.style.display = 'none';
        }

        if (!hasContent) {
            externalButtons.style.display = 'none';
        }
    } else {
        externalButtons.style.display = 'none';
    }
}

if(currentWords.length > 0) {
    showWord(currentIndex);
    setButtonLinks();
} else {
    document.querySelector('.word-card').innerHTML = "해당하는 단어장이 없습니다.";
    document.querySelector('.external-buttons').style.display = 'none';
}
</script>

</body>
</html>
